# icp-calculator

This repository contains a utility library that implements a calculator of fees
and costs for smart contracts on the Internet Computer Protocol (ICP).

Currently it supports the following operations and resources:

- **storage**: the cost to store some number of bytes for some period of time.
- **message execution**: the cost to execute some number of instructions.
- **message sending**: the cost to send some number of bytes as a message.
- **HTTP outcalls**: the cost to make an HTTP outcall.
- **canister creation**: the cost to create a canister.

More will be added in the future.

## Installation

```bash
# with npm
npm install --save-dev @dfinity/icp-calculator
# with pnpm
pnpm add --save-dev @dfinity/icp-calculator
# with yarn
yarn add -D @dfinity/icp-calculator
```

## Usage

See `src/index.spec.ts` for more examples of usage.

```typescript
import {
  calculators,
  Direction,
  Duration,
  Mode,
} from "@dfinity/icp-calculator";
import type { Bytes, Instructions } from "@dfinity/icp-calculator";

const $ = calculators().calculatorUSD;
const storage1mb = $.storage(1_000_000 as Bytes, Duration.fromDays(365));
const execute1b = $.execution(Mode.Replicated, 1_000_000_000 as Instructions);
const send1mb = $.message(
  Mode.Replicated,
  Direction.UserToCanister,
  1_000_000 as Bytes,
);

expect(storage1mb).toBeCloseTo(0.00494, 5);
expect(execute1b).toBeCloseTo(0.00053, 5);
expect(send1mb).toBeCloseTo(0.00265, 5);
```

## How it works

The main logic of the calculator is in `src/calculator.ts`.
The code there mirrors the replica code and it depends on the replica config, which is stored in `src/ipc/config.json`.
The JSON config file is generated by the `icp_config` tool in the replica repository.

The JSON config file can be updated as follows:

```
# Check out `https://github.com/dfinity/ic` to `~/ic`
# Check out `https://github.com/dfinity/icp-calculator` to `~/icp-calculator`
cd ~/ic
bazel run //rs/execution_environment/tools:icp_config -- --replica-version=rc--2024-07-25_01-30 --output=~/icp-calculator/src/icp/config.json
```

## Documentation

`@dfinity/icp-calculator` exposes following types and functions:

<!-- TSDOC_START -->

### :toolbox: Functions

- [calculator](#gear-calculator)
- [toUSD](#gear-tousd)
- [calculators](#gear-calculators)

#### :gear: calculator

Constructs a cost calculator that operates in cycles for the given subnet.

| Function     | Type                                                                                                                                                                 |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `calculator` | `({ subnetType, subnetSize, }: { subnetType?: SubnetType or undefined; subnetSize?: number or undefined; }) => { version: string; calculator: Calculator<Cycles>; }` |

Parameters:

- `subnetType`: - the type of the subnet: application or system.
- `subnetSize`: - the number of nodes in the subnet.

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/calculator.ts#L24)

#### :gear: toUSD

Constructs a calculator that operates in USD based on a calculator that
operates in cycles and based on the exchange rate between cycles and USD.

| Function | Type                                                                                                                                                                                |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `toUSD`  | `({ calculatorCycles, cyclesPerUSD, }: { calculatorCycles: Calculator<Cycles>; cyclesPerUSD?: Cycles or undefined; }) => { cyclesPerUSD: Cycles; calculatorUSD: Calculator<USD>; }` |

Parameters:

- `calculatorCycles`: - the base calculator that operates in cycles.
- `cyclesPerUSD`: - the exchange rate between cycles and USD.

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/usd.ts#L27)

#### :gear: calculators

The main export of the library. It returns cost calculators that operate in
cycles and USD based on the given options.

| Function      | Type                                              |
| ------------- | ------------------------------------------------- |
| `calculators` | `(options?: Options or undefined) => Calculators` |

Parameters:

- `options`: - optional options to configure the calculators.

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/index.ts#L64)

### :factory: Duration

A type that represent time duration.

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/types.ts#L24)

#### Methods

- [asSeconds](#gear-asseconds)
- [fromSeconds](#gear-fromseconds)
- [fromHours](#gear-fromhours)
- [fromDays](#gear-fromdays)

##### :gear: asSeconds

| Method      | Type           |
| ----------- | -------------- |
| `asSeconds` | `() => number` |

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/types.ts#L31)

##### :gear: fromSeconds

| Method        | Type                            |
| ------------- | ------------------------------- |
| `fromSeconds` | `(seconds: number) => Duration` |

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/types.ts#L35)

##### :gear: fromHours

| Method      | Type                          |
| ----------- | ----------------------------- |
| `fromHours` | `(hours: number) => Duration` |

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/types.ts#L39)

##### :gear: fromDays

| Method     | Type                         |
| ---------- | ---------------------------- |
| `fromDays` | `(days: number) => Duration` |

[:link: Source](https://github.com/dfinity/icp-calculator/tree/main/src/types.ts#L44)

### :nut_and_bolt: Enum

- [Mode](#gear-mode)
- [Direction](#gear-direction)
- [SubnetType](#gear-subnettype)

#### :gear: Mode

A type that represent execution mode:

- replicated execution corresponds to update (and other) calls that are
  executed on all nodes and go through consensus.

- non-replicated execution corresponds to read-only query calls that are
  executed on a single node and don't go through consensus.

| Property        | Type | Description |
| --------------- | ---- | ----------- |
| `Replicated`    | ``   |             |
| `NonReplicated` | ``   |             |

#### :gear: Direction

The direction of sending a message:

- user-to-canister: the message is sent by a user to a canister. These
  messages in replicated execution mode are also known as 'ingress' messages.

- canister-to-canister: the message is sent from a canister to a canister.
  These messages are also known as cross-canister calls.

| Property             | Type | Description |
| -------------------- | ---- | ----------- |
| `UserToCanister`     | ``   |             |
| `CanisterToCanister` | ``   |             |

#### :gear: SubnetType

The type of a subnet.

Most users will use an application subnet.

| Property      | Type | Description |
| ------------- | ---- | ----------- |
| `Application` | ``   |             |
| `System`      | ``   |             |

<!-- TSDOC_END -->
